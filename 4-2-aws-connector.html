<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="AWS Connector Setup - Connect AWS accounts to Microsoft Defender for Cloud for multi-cloud security posture management.">
    <title>AWS Connector Setup - Microsoft Defender for Cloud</title>
    <link rel="stylesheet" href="../css/main.css">
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸ›¡ï¸</text></svg>">
</head>
<body>
    <div class="app-container">
        <aside class="sidebar">
            <div class="sidebar-header">
                <a href="../index.html" class="sidebar-logo">
                    <div class="logo-icon">MDC</div>
                    <span class="logo-text">Defender for Cloud</span>
                </a>
                <button class="sidebar-toggle" aria-label="Toggle sidebar">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M12.79 5.23a.75.75 0 01-.02 1.06L8.832 10l3.938 3.71a.75.75 0 11-1.04 1.08l-4.5-4.25a.75.75 0 010-1.08l4.5-4.25a.75.75 0 011.06.02z" clip-rule="evenodd" />
                    </svg>
                </button>
            </div>
            <nav class="sidebar-nav">
                <div class="nav-section">
                    <div class="nav-section-title">Multi-Cloud</div>
                    <div class="nav-group expanded" data-group="multicloud">
                        <div class="nav-group-header">
                            <span class="nav-group-title">Multi-Cloud & Hybrid</span>
                            <svg class="nav-group-toggle" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M7.21 14.77a.75.75 0 01.02-1.06L11.168 10 7.23 6.29a.75.75 0 111.04-1.08l4.5 4.25a.75.75 0 010 1.08l-4.5 4.25a.75.75 0 01-1.06-.02z" clip-rule="evenodd" />
                            </svg>
                        </div>
                        <div class="nav-group-items">
                            <a href="4-1-multicloud-overview.html" class="nav-subitem">Multi-Cloud Overview</a>
                            <a href="4-2-aws-connector.html" class="nav-subitem active">AWS Connector</a>
                            <a href="4-3-aws-cspm.html" class="nav-subitem">AWS CSPM</a>
                            <a href="4-4-gcp-connector.html" class="nav-subitem">GCP Connector</a>
                            <a href="4-5-gcp-cspm.html" class="nav-subitem">GCP CSPM</a>
                            <a href="4-6-arc-servers.html" class="nav-subitem">Azure Arc Servers</a>
                        </div>
                    </div>
                </div>
            </nav>
        </aside>

        <main class="main-content">
            <header class="header">
                <div class="header-left">
                    <button class="mobile-menu-btn" aria-label="Open menu">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M2 4.75A.75.75 0 012.75 4h14.5a.75.75 0 010 1.5H2.75A.75.75 0 012 4.75zM2 10a.75.75 0 01.75-.75h14.5a.75.75 0 010 1.5H2.75A.75.75 0 012 10zm0 5.25a.75.75 0 01.75-.75h14.5a.75.75 0 010 1.5H2.75a.75.75 0 01-.75-.75z" clip-rule="evenodd" />
                        </svg>
                    </button>
                    <div class="search-box">
                        <svg class="search-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M9 3.5a5.5 5.5 0 100 11 5.5 5.5 0 000-11zM2 9a7 7 0 1112.452 4.391l3.328 3.329a.75.75 0 11-1.06 1.06l-3.329-3.328A7 7 0 012 9z" clip-rule="evenodd" />
                        </svg>
                        <input type="text" class="search-input" placeholder="Search documentation..." readonly>
                        <span class="search-shortcut">âŒ˜K</span>
                    </div>
                </div>
            </header>

            <div class="content-wrapper">
                <article class="page-content">
                    <nav class="breadcrumbs">
                        <a href="../index.html" class="breadcrumb-item">Home</a>
                        <span class="breadcrumb-separator">/</span>
                        <a href="4-1-multicloud-overview.html" class="breadcrumb-item">Multi-Cloud</a>
                        <span class="breadcrumb-separator">/</span>
                        <span class="breadcrumb-item current">AWS Connector</span>
                    </nav>

                    <header class="page-header">
                        <h1>AWS Connector Setup</h1>
                        <div class="page-meta">
                            <span class="badge badge-l2">L2 Technical</span>
                            <span class="badge badge-l3">L3 Advanced</span>
                            <span class="page-meta-item">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm.75-13a.75.75 0 00-1.5 0v5c0 .414.336.75.75.75h4a.75.75 0 000-1.5h-3.25V5z" clip-rule="evenodd" />
                                </svg>
                                25 min setup
                            </span>
                        </div>
                    </header>

                    <section>
                        <p>
                            Connect your AWS accounts to Microsoft Defender for Cloud to get unified security 
                            posture management across Azure and AWS. This guide covers both single-account 
                            and organization-level (multi-account) deployments.
                        </p>

                        <div class="callout callout-info">
                            <div class="callout-title">Prerequisites</div>
                            <div class="callout-content">
                                <ul>
                                    <li><strong>Azure:</strong> Security Admin or Owner on the subscription</li>
                                    <li><strong>AWS:</strong> Admin access to AWS account(s) or AWS Organizations</li>
                                    <li><strong>For Organizations:</strong> Management account access</li>
                                </ul>
                            </div>
                        </div>
                    </section>

                    <!-- Architecture -->
                    <section>
                        <h2 id="architecture">Connector Architecture</h2>

                        <div class="ascii-diagram">
<span class="highlight-cyan">â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—</span>
<span class="highlight-cyan">â•‘</span>                          <span class="highlight-blue">AWS TO MDC CONNECTOR ARCHITECTURE</span>                                 <span class="highlight-cyan">â•‘</span>
<span class="highlight-cyan">â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£</span>
<span class="highlight-cyan">â•‘</span>                                                                                              <span class="highlight-cyan">â•‘</span>
<span class="highlight-cyan">â•‘</span>   <span class="highlight-orange">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span>          <span class="highlight-blue">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span> <span class="highlight-cyan">â•‘</span>
<span class="highlight-cyan">â•‘</span>   <span class="highlight-orange">â”‚              AWS ACCOUNT               â”‚</span>          <span class="highlight-blue">â”‚          MICROSOFT AZURE         â”‚</span> <span class="highlight-cyan">â•‘</span>
<span class="highlight-cyan">â•‘</span>   <span class="highlight-orange">â”‚                                         â”‚</span>          <span class="highlight-blue">â”‚                                  â”‚</span> <span class="highlight-cyan">â•‘</span>
<span class="highlight-cyan">â•‘</span>   <span class="highlight-orange">â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚</span>          <span class="highlight-blue">â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚</span> <span class="highlight-cyan">â•‘</span>
<span class="highlight-cyan">â•‘</span>   <span class="highlight-orange">â”‚  â”‚      CloudFormation Stack       â”‚   â”‚</span>          <span class="highlight-blue">â”‚  â”‚   Defender for Cloud        â”‚  â”‚</span> <span class="highlight-cyan">â•‘</span>
<span class="highlight-cyan">â•‘</span>   <span class="highlight-orange">â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚   â”‚</span>          <span class="highlight-blue">â”‚  â”‚                              â”‚  â”‚</span> <span class="highlight-cyan">â•‘</span>
<span class="highlight-cyan">â•‘</span>   <span class="highlight-orange">â”‚  â”‚  â”‚   IAM Role (Cross-Account)â”‚  â”‚â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â–º  AWS Connector           â”‚  â”‚</span> <span class="highlight-cyan">â•‘</span>
<span class="highlight-cyan">â•‘</span>   <span class="highlight-orange">â”‚  â”‚  â”‚   Trust: Azure Tenant ID  â”‚  â”‚   â”‚</span>          <span class="highlight-blue">â”‚  â”‚  (Security Connector)        â”‚  â”‚</span> <span class="highlight-cyan">â•‘</span>
<span class="highlight-cyan">â•‘</span>   <span class="highlight-orange">â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚   â”‚</span>          <span class="highlight-blue">â”‚  â”‚                              â”‚  â”‚</span> <span class="highlight-cyan">â•‘</span>
<span class="highlight-cyan">â•‘</span>   <span class="highlight-orange">â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚   â”‚</span>          <span class="highlight-blue">â”‚  â”‚  Capabilities:               â”‚  â”‚</span> <span class="highlight-cyan">â•‘</span>
<span class="highlight-cyan">â•‘</span>   <span class="highlight-orange">â”‚  â”‚  â”‚   SecurityAudit Policy    â”‚  â”‚   â”‚</span>          <span class="highlight-blue">â”‚  â”‚  â€¢ CSPM (Free)               â”‚  â”‚</span> <span class="highlight-cyan">â•‘</span>
<span class="highlight-cyan">â•‘</span>   <span class="highlight-orange">â”‚  â”‚  â”‚   (Read-only access)      â”‚  â”‚   â”‚</span>          <span class="highlight-blue">â”‚  â”‚  â€¢ Defender CSPM (Paid)      â”‚  â”‚</span> <span class="highlight-cyan">â•‘</span>
<span class="highlight-cyan">â•‘</span>   <span class="highlight-orange">â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚   â”‚</span>          <span class="highlight-blue">â”‚  â”‚  â€¢ Defender for Servers      â”‚  â”‚</span> <span class="highlight-cyan">â•‘</span>
<span class="highlight-cyan">â•‘</span>   <span class="highlight-orange">â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚</span>          <span class="highlight-blue">â”‚  â”‚  â€¢ Defender for Containers   â”‚  â”‚</span> <span class="highlight-cyan">â•‘</span>
<span class="highlight-cyan">â•‘</span>   <span class="highlight-orange">â”‚                                         â”‚</span>          <span class="highlight-blue">â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚</span> <span class="highlight-cyan">â•‘</span>
<span class="highlight-cyan">â•‘</span>   <span class="highlight-orange">â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚</span>          <span class="highlight-blue">â”‚                                  â”‚</span> <span class="highlight-cyan">â•‘</span>
<span class="highlight-cyan">â•‘</span>   <span class="highlight-orange">â”‚  â”‚         AWS Resources           â”‚   â”‚</span>          <span class="highlight-blue">â”‚  Data Flow:                      â”‚</span> <span class="highlight-cyan">â•‘</span>
<span class="highlight-cyan">â•‘</span>   <span class="highlight-orange">â”‚  â”‚  EC2, S3, RDS, Lambda, EKS...   â”‚â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â–º  Recommendations            â”‚</span> <span class="highlight-cyan">â•‘</span>
<span class="highlight-cyan">â•‘</span>   <span class="highlight-orange">â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚</span>          <span class="highlight-blue">â”‚      Secure Score                â”‚</span> <span class="highlight-cyan">â•‘</span>
<span class="highlight-cyan">â•‘</span>   <span class="highlight-orange">â”‚                                         â”‚</span>          <span class="highlight-blue">â”‚      Attack Paths                â”‚</span> <span class="highlight-cyan">â•‘</span>
<span class="highlight-cyan">â•‘</span>   <span class="highlight-orange">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span>          <span class="highlight-blue">â”‚      Alerts                      â”‚</span> <span class="highlight-cyan">â•‘</span>
<span class="highlight-cyan">â•‘</span>                                                       <span class="highlight-blue">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span> <span class="highlight-cyan">â•‘</span>
<span class="highlight-cyan">â•‘</span>                                                                                              <span class="highlight-cyan">â•‘</span>
<span class="highlight-cyan">â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•</span>
                        </div>
                    </section>

                    <!-- Setup Options -->
                    <section>
                        <h2 id="setup-options">Setup Options</h2>

                        <div class="table-wrapper">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Option</th>
                                        <th>Use Case</th>
                                        <th>Complexity</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td><strong>Single Account</strong></td>
                                        <td>Small environments, testing, PoC</td>
                                        <td>Low - 15 min</td>
                                    </tr>
                                    <tr>
                                        <td><strong>AWS Organizations</strong></td>
                                        <td>Enterprise, multiple accounts</td>
                                        <td>Medium - 30 min</td>
                                    </tr>
                                    <tr>
                                        <td><strong>StackSets (Advanced)</strong></td>
                                        <td>Automated multi-account at scale</td>
                                        <td>High - requires AWS expertise</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </section>

                    <!-- Single Account Setup -->
                    <section>
                        <h2 id="single-account">Single Account Setup</h2>

                        <div class="timeline">
                            <div class="timeline-item">
                                <div class="timeline-marker">1</div>
                                <div class="timeline-content">
                                    <h4>Navigate to Environment Settings</h4>
                                    <p>Azure Portal â†’ Defender for Cloud â†’ Environment settings â†’ Add environment â†’ Amazon Web Services</p>
                                </div>
                            </div>

                            <div class="timeline-item">
                                <div class="timeline-marker">2</div>
                                <div class="timeline-content">
                                    <h4>Configure Connector Details</h4>
                                    <ul>
                                        <li>Connector name (e.g., "AWS-Production")</li>
                                        <li>Select Azure subscription to host connector</li>
                                        <li>Choose region</li>
                                        <li>Enter AWS Account ID</li>
                                    </ul>
                                </div>
                            </div>

                            <div class="timeline-item">
                                <div class="timeline-marker">3</div>
                                <div class="timeline-content">
                                    <h4>Select Plans</h4>
                                    <div class="table-wrapper">
                                        <table class="table-compact">
                                            <tr>
                                                <td><strong>Foundational CSPM</strong></td>
                                                <td>Free</td>
                                                <td>Basic posture, recommendations</td>
                                            </tr>
                                            <tr>
                                                <td><strong>Defender CSPM</strong></td>
                                                <td>~$5/server/month</td>
                                                <td>Attack paths, Cloud Security Graph</td>
                                            </tr>
                                            <tr>
                                                <td><strong>Defender for Servers</strong></td>
                                                <td>P1: $5, P2: $15/server</td>
                                                <td>EC2 protection via Arc</td>
                                            </tr>
                                            <tr>
                                                <td><strong>Defender for Containers</strong></td>
                                                <td>~$7/vCPU/month</td>
                                                <td>EKS protection</td>
                                            </tr>
                                        </table>
                                    </div>
                                </div>
                            </div>

                            <div class="timeline-item">
                                <div class="timeline-marker">4</div>
                                <div class="timeline-content">
                                    <h4>Download CloudFormation Template</h4>
                                    <p>Click "Download CloudFormation template" - this creates the required IAM role.</p>
                                </div>
                            </div>

                            <div class="timeline-item">
                                <div class="timeline-marker">5</div>
                                <div class="timeline-content">
                                    <h4>Deploy in AWS</h4>
                                    <p>AWS Console â†’ CloudFormation â†’ Create stack â†’ Upload template</p>
                                </div>
                            </div>
                        </div>

                        <h3>AWS CLI Deployment</h3>

                        <div class="code-header">
                            <span class="code-lang">AWS CLI</span>
                            <button class="code-copy-btn">Copy</button>
                        </div>
                        <pre><code class="language-bash"># Deploy CloudFormation stack for MDC connector
aws cloudformation create-stack \
    --stack-name "Microsoft-Defender-for-Cloud" \
    --template-body file://mdc-connector-template.json \
    --capabilities CAPABILITY_NAMED_IAM \
    --parameters \
        ParameterKey=AzureTenantId,ParameterValue="your-azure-tenant-id" \
        ParameterKey=ConnectorGuid,ParameterValue="connector-guid-from-azure"

# Check stack status
aws cloudformation describe-stacks \
    --stack-name "Microsoft-Defender-for-Cloud" \
    --query "Stacks[0].StackStatus"

# Get the IAM role ARN (needed for verification)
aws cloudformation describe-stacks \
    --stack-name "Microsoft-Defender-for-Cloud" \
    --query "Stacks[0].Outputs[?OutputKey=='RoleArn'].OutputValue" \
    --output text</code></pre>
                    </section>

                    <!-- AWS Organizations Setup -->
                    <section>
                        <h2 id="organizations">AWS Organizations Setup</h2>

                        <div class="callout callout-tip">
                            <div class="callout-title">Recommended for Enterprise</div>
                            <div class="callout-content">
                                <p>Organization-level connection automatically discovers and connects all member accounts, 
                                including new accounts added later.</p>
                            </div>
                        </div>

                        <h3>Management Account Deployment</h3>

                        <div class="code-header">
                            <span class="code-lang">AWS CLI</span>
                            <button class="code-copy-btn">Copy</button>
                        </div>
                        <pre><code class="language-bash"># Step 1: Enable trusted access for StackSets (run from management account)
aws organizations enable-aws-service-access \
    --service-principal stacksets.cloudformation.amazonaws.com

# Step 2: Create StackSet for all accounts
aws cloudformation create-stack-set \
    --stack-set-name "Microsoft-Defender-for-Cloud-Org" \
    --template-body file://mdc-connector-template.json \
    --capabilities CAPABILITY_NAMED_IAM \
    --permission-model SERVICE_MANAGED \
    --auto-deployment Enabled=true,RetainStacksOnAccountRemoval=false \
    --parameters \
        ParameterKey=AzureTenantId,ParameterValue="your-azure-tenant-id" \
        ParameterKey=ConnectorGuid,ParameterValue="org-connector-guid"

# Step 3: Create stack instances in all accounts
aws cloudformation create-stack-instances \
    --stack-set-name "Microsoft-Defender-for-Cloud-Org" \
    --deployment-targets OrganizationalUnitIds=r-xxxx \
    --regions us-east-1 \
    --operation-preferences FailureTolerancePercentage=0,MaxConcurrentPercentage=100</code></pre>

                        <h3>Verify Deployment</h3>

                        <div class="code-header">
                            <span class="code-lang">AWS CLI</span>
                            <button class="code-copy-btn">Copy</button>
                        </div>
                        <pre><code class="language-bash"># List all stack instances
aws cloudformation list-stack-instances \
    --stack-set-name "Microsoft-Defender-for-Cloud-Org" \
    --query "Summaries[*].{Account:Account,Status:Status,Region:Region}"

# Check for failed deployments
aws cloudformation list-stack-instances \
    --stack-set-name "Microsoft-Defender-for-Cloud-Org" \
    --query "Summaries[?Status!='CURRENT']"</code></pre>
                    </section>

                    <!-- IAM Role Details -->
                    <section>
                        <h2 id="iam-role">IAM Role Configuration</h2>

                        <p>The connector uses a cross-account IAM role with the following configuration:</p>

                        <h3>Trust Policy</h3>

                        <div class="code-header">
                            <span class="code-lang">JSON</span>
                            <button class="code-copy-btn">Copy</button>
                        </div>
                        <pre><code class="language-json">{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Principal": {
        "Federated": "arn:aws:iam::AWS_ACCOUNT_ID:saml-provider/AWSSSO"
      },
      "Action": "sts:AssumeRoleWithSAML",
      "Condition": {
        "StringEquals": {
          "SAML:aud": "https://signin.aws.amazon.com/saml"
        }
      }
    },
    {
      "Effect": "Allow",
      "Principal": {
        "AWS": "arn:aws:iam::MICROSOFT_ACCOUNT_ID:root"
      },
      "Action": "sts:AssumeRole",
      "Condition": {
        "StringEquals": {
          "sts:ExternalId": "YOUR_CONNECTOR_GUID"
        }
      }
    }
  ]
}</code></pre>

                        <h3>Required Permissions</h3>

                        <div class="table-wrapper">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Capability</th>
                                        <th>AWS Managed Policy</th>
                                        <th>Purpose</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>CSPM (All)</td>
                                        <td><code>SecurityAudit</code></td>
                                        <td>Read-only access to security configurations</td>
                                    </tr>
                                    <tr>
                                        <td>Defender CSPM</td>
                                        <td><code>SecurityAudit</code> + custom</td>
                                        <td>Additional for sensitive data discovery</td>
                                    </tr>
                                    <tr>
                                        <td>Servers</td>
                                        <td><code>AmazonSSMReadOnlyAccess</code></td>
                                        <td>Arc agent deployment via SSM</td>
                                    </tr>
                                    <tr>
                                        <td>Containers</td>
                                        <td><code>AmazonEKSClusterPolicy</code></td>
                                        <td>EKS cluster access</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>

                        <div class="callout callout-warning">
                            <div class="callout-title">Least Privilege</div>
                            <div class="callout-content">
                                <p>The <code>SecurityAudit</code> policy is read-only. MDC cannot make changes to your 
                                AWS environment - it only reads configuration data.</p>
                            </div>
                        </div>
                    </section>

                    <!-- Verification -->
                    <section>
                        <h2 id="verification">Verification & Troubleshooting</h2>

                        <h3>Check Connection Status</h3>

                        <div class="code-header">
                            <span class="code-lang">Azure CLI</span>
                            <button class="code-copy-btn">Copy</button>
                        </div>
                        <pre><code class="language-bash"># List AWS connectors
az security security-connector list \
    --query "[?environmentName=='AWS'].{Name:name,Status:hierarchyIdentifier,Created:systemData.createdAt}"

# Get connector details
az security security-connector show \
    --name "your-aws-connector-name" \
    --resource-group "your-rg"</code></pre>

                        <h3>Common Issues</h3>

                        <div class="accordion">
                            <div class="accordion-item expanded">
                                <div class="accordion-header">
                                    <span class="accordion-title">Connector shows "Unhealthy" status</span>
                                    <svg class="accordion-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                        <path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 11.168l3.71-3.938a.75.75 0 111.08 1.04l-4.25 4.5a.75.75 0 01-1.08 0l-4.25-4.5a.75.75 0 01.02-1.06z" clip-rule="evenodd" />
                                    </svg>
                                </div>
                                <div class="accordion-content">
                                    <p><strong>Causes:</strong></p>
                                    <ul>
                                        <li>IAM role trust policy incorrect</li>
                                        <li>External ID mismatch</li>
                                        <li>Role permissions insufficient</li>
                                    </ul>
                                    
                                    <p><strong>Diagnostic:</strong></p>
                                    <div class="code-header">
                                        <span class="code-lang">AWS CLI</span>
                                        <button class="code-copy-btn">Copy</button>
                                    </div>
                                    <pre><code class="language-bash"># Verify role exists
aws iam get-role --role-name "AzureDefenderForCloud"

# Check trust policy
aws iam get-role --role-name "AzureDefenderForCloud" \
    --query "Role.AssumeRolePolicyDocument"

# Verify attached policies
aws iam list-attached-role-policies \
    --role-name "AzureDefenderForCloud"</code></pre>
                                </div>
                            </div>

                            <div class="accordion-item">
                                <div class="accordion-header">
                                    <span class="accordion-title">No recommendations appearing</span>
                                    <svg class="accordion-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                        <path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 11.168l3.71-3.938a.75.75 0 111.08 1.04l-4.25 4.5a.75.75 0 01-1.08 0l-4.25-4.5a.75.75 0 01.02-1.06z" clip-rule="evenodd" />
                                    </svg>
                                </div>
                                <div class="accordion-content">
                                    <p><strong>Wait time:</strong> Initial scan takes 4-24 hours</p>
                                    <p><strong>Check:</strong></p>
                                    <ul>
                                        <li>Connector status is "Healthy"</li>
                                        <li>CSPM plan is enabled</li>
                                        <li>AWS account has resources to assess</li>
                                    </ul>
                                </div>
                            </div>

                            <div class="accordion-item">
                                <div class="accordion-header">
                                    <span class="accordion-title">CloudFormation stack failed</span>
                                    <svg class="accordion-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                        <path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 11.168l3.71-3.938a.75.75 0 111.08 1.04l-4.25 4.5a.75.75 0 01-1.08 0l-4.25-4.5a.75.75 0 01.02-1.06z" clip-rule="evenodd" />
                                    </svg>
                                </div>
                                <div class="accordion-content">
                                    <div class="code-header">
                                        <span class="code-lang">AWS CLI</span>
                                        <button class="code-copy-btn">Copy</button>
                                    </div>
                                    <pre><code class="language-bash"># Get stack events for failure reason
aws cloudformation describe-stack-events \
    --stack-name "Microsoft-Defender-for-Cloud" \
    --query "StackEvents[?ResourceStatus=='CREATE_FAILED'].{Resource:LogicalResourceId,Reason:ResourceStatusReason}"</code></pre>
                                    
                                    <p><strong>Common failures:</strong></p>
                                    <ul>
                                        <li>IAM permissions - need CAPABILITY_NAMED_IAM</li>
                                        <li>Role already exists - delete and recreate</li>
                                        <li>Parameter validation - check tenant ID format</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </section>

                    <!-- EC2 Protection -->
                    <section>
                        <h2 id="ec2-protection">EC2 Protection with Defender for Servers</h2>

                        <p>To get full server protection on EC2 instances, you need to install the Azure Arc agent:</p>

                        <div class="ascii-diagram">
<span class="highlight-cyan">â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—</span>
<span class="highlight-cyan">â•‘</span>                        <span class="highlight-blue">EC2 PROTECTION ARCHITECTURE</span>                                        <span class="highlight-cyan">â•‘</span>
<span class="highlight-cyan">â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£</span>
<span class="highlight-cyan">â•‘</span>                                                                                              <span class="highlight-cyan">â•‘</span>
<span class="highlight-cyan">â•‘</span>   <span class="highlight-orange">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span>                                                 <span class="highlight-cyan">â•‘</span>
<span class="highlight-cyan">â•‘</span>   <span class="highlight-orange">â”‚            EC2 Instance             â”‚</span>                                                 <span class="highlight-cyan">â•‘</span>
<span class="highlight-cyan">â•‘</span>   <span class="highlight-orange">â”‚                                     â”‚</span>          <span class="highlight-blue">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span>     <span class="highlight-cyan">â•‘</span>
<span class="highlight-cyan">â•‘</span>   <span class="highlight-orange">â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚</span>          <span class="highlight-blue">â”‚       Azure Arc             â”‚</span>     <span class="highlight-cyan">â•‘</span>
<span class="highlight-cyan">â•‘</span>   <span class="highlight-orange">â”‚  â”‚     Azure Arc Agent         â”‚â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º  (Resource in Azure)        â”‚</span>     <span class="highlight-cyan">â•‘</span>
<span class="highlight-cyan">â•‘</span>   <span class="highlight-orange">â”‚  â”‚     (azcmagent)             â”‚   â”‚</span>          <span class="highlight-blue">â”‚                             â”‚</span>     <span class="highlight-cyan">â•‘</span>
<span class="highlight-cyan">â•‘</span>   <span class="highlight-orange">â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚</span>          <span class="highlight-blue">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span>     <span class="highlight-cyan">â•‘</span>
<span class="highlight-cyan">â•‘</span>   <span class="highlight-orange">â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚</span>                         â”‚                      <span class="highlight-cyan">â•‘</span>
<span class="highlight-cyan">â•‘</span>   <span class="highlight-orange">â”‚  â”‚     MDE Agent               â”‚   â”‚</span>                         â–¼                      <span class="highlight-cyan">â•‘</span>
<span class="highlight-cyan">â•‘</span>   <span class="highlight-orange">â”‚  â”‚     (Auto-deployed via Arc) â”‚â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º   <span class="highlight-purple">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span>     <span class="highlight-cyan">â•‘</span>
<span class="highlight-cyan">â•‘</span>   <span class="highlight-orange">â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚</span>          <span class="highlight-purple">â”‚   Defender for Servers      â”‚</span>     <span class="highlight-cyan">â•‘</span>
<span class="highlight-cyan">â•‘</span>   <span class="highlight-orange">â”‚                                     â”‚</span>          <span class="highlight-purple">â”‚   â€¢ Vulnerability Scanning  â”‚</span>     <span class="highlight-cyan">â•‘</span>
<span class="highlight-cyan">â•‘</span>   <span class="highlight-orange">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span>          <span class="highlight-purple">â”‚   â€¢ Threat Detection        â”‚</span>     <span class="highlight-cyan">â•‘</span>
<span class="highlight-cyan">â•‘</span>                                                  <span class="highlight-purple">â”‚   â€¢ EDR                     â”‚</span>     <span class="highlight-cyan">â•‘</span>
<span class="highlight-cyan">â•‘</span>                                                  <span class="highlight-purple">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span>     <span class="highlight-cyan">â•‘</span>
<span class="highlight-cyan">â•‘</span>                                                                                              <span class="highlight-cyan">â•‘</span>
<span class="highlight-cyan">â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•</span>
                        </div>

                        <h3>Auto-Provisioning via SSM</h3>

                        <p>When Defender for Servers is enabled, MDC can automatically deploy Arc agents via AWS Systems Manager:</p>

                        <div class="code-header">
                            <span class="code-lang">AWS CLI</span>
                            <button class="code-copy-btn">Copy</button>
                        </div>
                        <pre><code class="language-bash"># Verify SSM agent is running on EC2 instances
aws ssm describe-instance-information \
    --query "InstanceInformationList[*].{InstanceId:InstanceId,PingStatus:PingStatus,AgentVersion:AgentVersion}"

# Check Arc agent deployment status
aws ssm list-command-invocations \
    --command-id "arc-deployment-command-id" \
    --details</code></pre>

                        <h3>Manual Arc Agent Installation</h3>

                        <div class="code-header">
                            <span class="code-lang">Bash (On EC2)</span>
                            <button class="code-copy-btn">Copy</button>
                        </div>
                        <pre><code class="language-bash"># Download and install Arc agent (Linux)
wget https://aka.ms/azcmagent -O /tmp/install_linux_azcmagent.sh
chmod +x /tmp/install_linux_azcmagent.sh
sudo /tmp/install_linux_azcmagent.sh

# Connect to Azure
sudo azcmagent connect \
    --resource-group "your-arc-rg" \
    --tenant-id "your-tenant-id" \
    --location "eastus" \
    --subscription-id "your-sub-id" \
    --cloud "AzureCloud" \
    --tags "Environment=Production,Source=AWS"</code></pre>
                    </section>

                    <!-- Key Takeaways -->
                    <div class="key-takeaways">
                        <div class="key-takeaways-title">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M10 2a.75.75 0 01.75.75v.258a33.186 33.186 0 016.668.83.75.75 0 01-.336 1.461z" clip-rule="evenodd" />
                            </svg>
                            Key Takeaways
                        </div>
                        <ul>
                            <li>Use AWS Organizations connector for multi-account environments</li>
                            <li>CloudFormation template creates a read-only IAM role - no write access</li>
                            <li>Initial scan takes 4-24 hours - don't expect immediate recommendations</li>
                            <li>EC2 protection requires Azure Arc agent deployment</li>
                            <li>External ID in trust policy must match connector GUID exactly</li>
                            <li>StackSets enable automatic deployment to new accounts</li>
                        </ul>
                    </div>

                    <div class="related-pages">
                        <div class="related-title">Related Pages</div>
                        <div class="related-list">
                            <a href="4-3-aws-cspm.html" class="related-link">AWS CSPM</a>
                            <a href="4-4-gcp-connector.html" class="related-link">GCP Connector</a>
                            <a href="4-6-arc-servers.html" class="related-link">Azure Arc Servers</a>
                            <a href="12-6-troubleshooting.html" class="related-link">Troubleshooting</a>
                        </div>
                    </div>

                    <nav class="page-nav">
                        <a href="4-1-multicloud-overview.html" class="page-nav-link prev">
                            <span class="page-nav-label">â† Previous</span>
                            <span class="page-nav-title">Multi-Cloud Overview</span>
                        </a>
                        <a href="4-3-aws-cspm.html" class="page-nav-link next">
                            <span class="page-nav-label">Next â†’</span>
                            <span class="page-nav-title">AWS CSPM</span>
                        </a>
                    </nav>
                </article>

                <aside class="toc-sidebar">
                    <div class="toc-title">On This Page</div>
                    <ul class="toc-list">
                        <li class="toc-item"><a href="#architecture" class="toc-link">Architecture</a></li>
                        <li class="toc-item"><a href="#setup-options" class="toc-link">Setup Options</a></li>
                        <li class="toc-item"><a href="#single-account" class="toc-link">Single Account</a></li>
                        <li class="toc-item"><a href="#organizations" class="toc-link">AWS Organizations</a></li>
                        <li class="toc-item"><a href="#iam-role" class="toc-link">IAM Role</a></li>
                        <li class="toc-item"><a href="#verification" class="toc-link">Verification</a></li>
                        <li class="toc-item"><a href="#ec2-protection" class="toc-link">EC2 Protection</a></li>
                    </ul>
                </aside>
            </div>
        </main>
        <div class="mobile-overlay"></div>
    </div>

    <div class="search-modal">
        <div class="search-modal-content">
            <input type="text" class="search-modal-input" placeholder="Search documentation..." autofocus>
            <div class="search-results"></div>
        </div>
    </div>

    <script src="../js/main.js"></script>
</body>
</html>
